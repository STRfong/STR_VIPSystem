{% extends "base.html" %}
{% block title %}VIP 名單{% endblock %}
{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>貴賓名單</h2>
        <a href="{% url 'VIPSystem_APP:vip_create' %}" class="btn btn-success">新增 VIP</a>
    </div>
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>姓名</th>
                    <th>
                        標籤
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-funnel" viewBox="0 0 16 16" data-bs-toggle="modal" data-bs-target="#tagFilterModal" style="cursor: pointer;">
                          <path d="M1.5 1.5A.5.5 0 0 1 2 1h12a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.128.334L10 8.692V13.5a.5.5 0 0 1-.342.474l-3 1A.5.5 0 0 1 6 14.5V8.692L1.628 3.834A.5.5 0 0 1 1.5 3.5zm1 .5v1.308l4.372 4.858A.5.5 0 0 1 7 8.5v5.306l2-.666V8.5a.5.5 0 0 1 .128-.334L13.5 3.308V2z"/>
                        </svg>

                        <!-- 標籤篩選 Modal -->
                        <div class="modal fade" id="tagFilterModal" tabindex="-1" aria-labelledby="tagFilterModalLabel" aria-hidden="true">
                          <div class="modal-dialog">
                            <div class="modal-content">
                              <div class="modal-header">
                                <h5 class="modal-title" id="tagFilterModalLabel">篩選標籤</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                              </div>
                              <div class="modal-body">
                                <form id="tagFilterForm">
                                    {% for tag in all_tags %}
                                      <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="tag_{{ tag.id }}" name="tags" value="{{ tag.id }}" onchange="this.nextElementSibling.querySelector('span').classList.toggle('bg-primary'); this.nextElementSibling.querySelector('span').classList.toggle('bg-secondary');">
                                        <label class="form-check-label" for="tag_{{ tag.id }}">
                                          <span class="badge rounded-pill bg-secondary">{{ tag.name }}</span>
                                        </label>
                                      </div>
                                    {% endfor %}
                                </form>
                              </div>
                              <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                                <button type="button" class="btn btn-primary" onclick="applyTagFilter()" id="applyTagFilterButton">應用篩選</button>
                              </div>
                            </div>
                          </div>
                        </div>
                    </th>
                    <th class="text-center align-middle" style="min-width: 150px; width: 150px;">
                        參與項目數
                        <div class="dropdown d-inline-block">
                            <button class="btn btn-sm btn-link dropdown-toggle" type="button" id="sortDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-sort"></i>
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="sortDropdown">
                                <li><a class="dropdown-item" href="#" onclick="applySortFilter('true')">由多到少</a></li>
                                <li><a class="dropdown-item" href="#" onclick="applySortFilter('false')">由少到多</a></li>
                            </ul>
                        </div>
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for vip in object_list %}
                <tr>
                    <td>
                      <a href="{% url 'VIPSystem_APP:vip_id' vip.pk %}" class="text-decoration-none">{{ vip.name }}</a>
                    </td>
                    <td>
                        {% if vip.tags.all %}
                            <div class="d-flex flex-wrap">
                                {% for tag in vip.tags.all %}
                                    <span class="badge rounded-pill bg-primary me-1 mb-1">{{ tag.name }}</span>
                                {% endfor %}
                            </div>
                        {% else %}
                            <span class="text-muted">無標籤</span>
                        {% endif %}
                    </td>
                    <td class="text-center align-middle">{{ vip.project__count }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<script>
    function applyTagFilter() {
      var selectedTags = [];
      var checkboxes = document.querySelectorAll('#tagFilterForm input[type="checkbox"]:checked');
      checkboxes.forEach(function(checkbox) {
        selectedTags.push(checkbox.value);
      });
      
      var url = new URL(window.location.href);
      url.searchParams.delete('tags');
      selectedTags.forEach(function(tag) {
        url.searchParams.append('tags', tag);
      });
      
      window.location.href = url.toString();
    }

    function applySortFilter(sortOrder) {
      var url = new URL(window.location.href);
      url.searchParams.set('sort_by_projects', sortOrder);
      window.location.href = url.toString();
    }
</script>
{% endblock %}
