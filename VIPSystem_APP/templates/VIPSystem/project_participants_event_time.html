{% extends "base.html" %}
{% block title %}專案詳細資料{% endblock %}
{% block content %}
<style>
    .pagination .page-link {
        color: #343a40; /* 字體顏色 */
        background-color: transparent; /* 背景透明 */
        border: 1px solid #343a40; /* 黑色邊框 */
    }

    .pagination .page-item.active .page-link {
        color: #fff; /* 活動狀態下的字體顏色 */
        background-color: #343a40; /* 活動狀態下的背景顏色 */
        border-color: #343a40; /* 活動狀態下的邊框顏色 */
    }

    .pagination .page-link:hover {
        color: #fff; /* 懸停時的字體顏色 */
        background-color: #495057; /* 懸停時的背景顏色 */
        border-color: #495057; /* 懸停時的邊框顏色 */
    }
</style>
{% if messages %}
    <div class="container mt-4" id="message-container">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    <script>
        setTimeout(function() {
            const container = document.getElementById('message-container');
            if (container) {
                container.remove();
            }
        }, 3000);
</script>
{% endif %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header bg-dark text-white">
            <h2 class="mb-0">{{ project.description }}《{{ project.name }}》{{event_time.date}} {{event_time.session}}</h2>
        </div>
        <div class="card-body">
            <!-- 大螢幕佈局 -->
            <div class="d-none d-lg-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">貴賓邀請名單</h3>
                <div class="d-flex justify-content-around gap-3">
                    <div class="card text-center" style="width: 10rem;">
                        <div class="card-body">
                            <h5 class="card-title">已邀請組數</h5>
                            <p class="card-text">{{invited_amount}} 組</p>
                        </div>
                    </div>
                    <div class="card text-center" style="width: 10rem;">
                        <div class="card-body">
                            <h5 class="card-title">可使用票數</h5>
                            <p class="card-text">
                                {% if ticket_count != 0 %}
                                    {{ticket_count}} 張
                                {% else %}
                                    無可使用票數
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    <div class="card text-center" style="width: 10rem;">
                        <div class="card-body">
                            <h5 class="card-title">已使用票數</h5>
                            <p class="card-text">{{invited_ticket_count}} 張</p>
                        </div>
                    </div>
                    <div class="card text-center" style="width: 10rem;">
                        <div class="card-body">
                            <h5 class="card-title">剩餘票數</h5>
                            <p class="card-text">{{remaining_ticket_count}} 張</p>
                        </div>
                    </div>
                </div>
                <div class="btn-group" role="group">
                    <button id="btnGroupDrop1" type="button" class="btn btn-outline-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                        貴賓名單操作
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="btnGroupDrop1">
                        <li><a href="{% url 'VIPSystem_APP:invite_list_event_time' project.pk event_time.section event_time.pk %}" class="dropdown-item">從資料庫新增貴賓</a></li>
                        <li><a href="#" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#addParticipantDirectlyModal">直接新增貴賓</a></li>
                        <li><a href="{% url 'VIPSystem_APP:send_emails_list_event_time' project.pk event_time.pk %}" class="dropdown-item">批量寄出邀請信</a></li>
                        <li><a href="{% url 'VIPSystem_APP:export_participants_event_time' project.pk event_time.section event_time.pk %}" class="dropdown-item">輸出貴賓名單</a></li>
                    </ul>
                </div>
            </div>

            <!-- 小螢幕佈局 -->
            <div class="d-lg-none">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="card-title mb-0">貴賓邀請名單</h3>
                    <div class="btn-group" role="group">
                        <button id="btnGroupDrop1" type="button" class="btn btn-outline-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                            貴賓名單操作
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="btnGroupDrop1">
                            <li><a href="{% url 'VIPSystem_APP:invite_list_event_time' project.pk event_time.section event_time.pk %}" class="dropdown-item">從資料庫新增貴賓</a></li>
                            <li><a href="#" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#addParticipantDirectlyModal">直接新增貴賓</a></li>
                            <li><a href="{% url 'VIPSystem_APP:send_emails_list_event_time' project.pk event_time.pk %}" class="dropdown-item">批量寄出邀請信</a></li>
                        </ul>
                    </div>
                </div>
                <div class="row row-cols-1 row-cols-sm-2 g-3">
                    <div class="col">
                        <div class="card text-center h-100">
                            <div class="card-body">
                                <h5 class="card-title">已邀請組數</h5>
                                <p class="card-text">{{invited_amount}} 組</p>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card text-center h-100">
                            <div class="card-body">
                                <h5 class="card-title">可使用票數</h5>
                                <p class="card-text">
                                    {% if ticket_count != 0 %}
                                        {{ticket_count}} 張
                                    {% else %}
                                        無可使用票數
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card text-center h-100">
                            <div class="card-body">
                                <h5 class="card-title">已使用票數</h5>
                                <p class="card-text">{{invited_ticket_count}} 張</p>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card text-center h-100">
                            <div class="card-body">
                                <h5 class="card-title">剩餘票數</h5>
                                <p class="card-text">{{remaining_ticket_count}} 張</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 直接新增貴賓 Modal -->
            <div class="modal fade" id="addParticipantDirectlyModal" data-bs-backdrop="static"tabindex="-1" aria-labelledby="addParticipantDirectlyModalLabel" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="addParticipantDirectlyModalLabel">直接新增貴賓</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body"> 
                    <form action="{% url 'VIPSystem_APP:update_participants_event_time_directly' project.pk event_time.section event_time.pk %}" method="POST">
                      {% csrf_token %}
                      <div class="row mb-3">
                        <label class="col-sm-4 col-form-label text-center" style="justify-content: center;" >貴賓姓名<span style="color: red;">*</span></label>
                        <div class="col-sm-8">
                          <input type="text" class="form-control" name="name" placeholder="請輸入貴賓姓名" required>
                        </div>
                      </div>
                      <div class="row mb-3">
                        <label class="col-sm-4 col-form-label text-center" style="justify-content: center;" >貴賓暱稱</label>
                        <div class="col-sm-8">
                          <input type="text" class="form-control" name="nickname" placeholder="請輸入貴賓暱稱">
                        </div>
                      </div>
                      <div class="row mb-3">
                        <label class="col-sm-4 col-form-label text-center" style="justify-content: center;" >貴賓單位</label>
                        <div class="col-sm-8">
                          <input type="text" class="form-control" name="organization" placeholder="請輸入貴賓單位">
                        </div>
                      </div>
                      <div class="row mb-3">
                        <label class="col-sm-4 col-form-label text-center" style="justify-content: center;" >貴賓職稱</label>
                        <div class="col-sm-8">
                          <input type="text" class="form-control" name="position" placeholder="請輸入貴賓職稱">
                        </div>
                      </div>
                      <div class="row mb-3">
                        <label class="col-sm-4 col-form-label text-center" style="justify-content: center;" >貴賓電話<span style="color: red;">*</span></label>
                        <div class="col-sm-8">
                          <input type="tel" class="form-control" name="phone" placeholder="請輸入貴賓電話" required>
                        </div>
                      </div>
                      <div class="row mb-3">
                        <label class="col-sm-4 col-form-label text-center" style="justify-content: center;" >貴賓電子信箱<span style="color: red;">*</span></label>
                        <div class="col-sm-8">
                          <input type="email" class="form-control" name="email" placeholder="請輸入貴賓電子信箱" required>
                        </div>
                      </div>
                      <div class="row mb-3">
                        <label class="col-sm-4 col-form-label text-center" style="justify-content: center;" >STR 聯絡人<span style="color: red;">*</span></label>
                        <div class="col-sm-8">
                          <input type="text" class="form-control" name="str_connect" placeholder="請輸入 STR 聯絡人" required>
                        </div>
                      </div>
                      <div class="row mb-3">
                        <label class="col-sm-4 col-form-label text-center" style="justify-content: center;" >備註</label>
                        <div class="col-sm-8">
                          <input type="text" class="form-control" name="notes" placeholder="備註">
                        </div>
                      </div>
                      <div class="row mb-3">
                        <label class="col-sm-4 col-form-label text-center" style="justify-content: center;" >提供票數<span style="color: red;">*</span></label>
                        <div class="col-sm-8">
                          <input type="number" class="form-control" name="wish_ticket_count" placeholder="請輸入提供票數" min="1" required>
                        </div>
                      </div>
                      <hr>
                      <h6>聯繫人資訊（若貴賓聯繫人非本人才需要填以下資訊）</h6>
                      <div class="row mb-3">
                        <label class="col-sm-4 col-form-label text-center" style="justify-content: center;" >聯繫人姓名</label>
                        <div class="col-sm-8">
                          <input type="text" class="form-control" name="poc" placeholder="請輸入聯繫人姓名">
                        </div>
                      </div>
                      <div class="row mb-3">
                        <label class="col-sm-4 col-form-label text-center" style="justify-content: center;" >聯繫人職稱</label>
                        <div class="col-sm-8">
                          <input type="text" class="form-control" name="poc_position" placeholder="請輸入聯繫人職稱">
                        </div>
                      </div>
                      <div class="row mb-3">
                        <label class="col-sm-4 col-form-label text-center" style="justify-content: center;" >聯繫人電話</label>
                        <div class="col-sm-8">
                          <input type="tel" class="form-control" name="poc_phone_number" placeholder="請輸入聯繫人電話">
                        </div>
                      </div>
                      <div class="row mb-3">
                        <label class="col-sm-4 col-form-label text-center" style="justify-content: center;" >聯繫人電子信箱</label>
                        <div class="col-sm-8">
                          <input type="email" class="form-control" name="poc_email" placeholder="請輸入聯繫人電子信箱">
                        </div>
                      </div>
                      <div class="modal-footer" style="display: flex; justify-content: space-between;">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="submit" class="btn btn-primary">新增</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
            {% if participants_list %}
                <div style="max-height: 70vh; overflow-y: auto;">
                    <table class="table table-striped mt-3">
                        <thead style="position: sticky; top: 0; background-color: white; z-index: 1;">
                            <tr>
                                <th style="width:  3%; text-align: center;">取</th>
                                <th style="width:  5%; text-align: center;">序號</th>
                                <th style="width:  6%;">姓名 <i class="bi bi-search" data-bs-toggle="modal" data-bs-target="#filterNameModal" style="cursor: pointer;"></i></th>
                                <th style="width:  8%;">單位 <i class="bi bi-search" data-bs-toggle="modal" data-bs-target="#filterOrganizationModal" style="cursor: pointer;"></i></th>
                                <th class="d-none d-lg-table-cell" style="width:  7%;">邀請人 <i class="bi bi-funnel" data-bs-toggle="modal" data-bs-target="#filterInvitedByModal" style="cursor: pointer;"></i></th>
                                <th style="width:  8%; text-align: center;">提供票數</th>
                                <th class="d-none d-lg-table-cell" style="width: 14%; text-align: center;">信件回覆狀態 <i class="bi bi-funnel" data-bs-toggle="modal" data-bs-target="#filterStatusModal" style="cursor: pointer;"></i></th>
                                <th class="d-none d-lg-table-cell" style="width:  6%; text-align: center;">索取票數</th>
                                <th class="d-none d-lg-table-cell" style="width:  5%; text-align: center;">確認信</th>
                                <th class="d-none d-lg-table-cell" style="width:  5%; text-align: center;">提醒信</th>
                                <th style="width: 10%;">備註</th>
                                <th style="width: 15%; text-align: center;">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for participant in participants_list %}
                            <tr class="vip-row" data-vip-name="{{ participant.vip.name }}"
                            data-vip-id="{{ participant.vip.id }}"
                            data-vip-nickname="{{ participant.vip.nickname }}"
                            data-vip-organization="{{ participant.vip.organization }}"
                            data-vip-position="{{ participant.vip.position }}"
                            data-vip-phone-number="{{ participant.vip.phone_number }}"
                            data-vip-email="{{ participant.vip.email }}"
                            data-status="{{ participant.get_status_display }}"
                            data-invited-by="{{ participant.invited_by.profile.nickname }}"
                            data-invited-by-email="{{ participant.invited_by.email }}"
                            data-wish-attend="{{ participant.wish_attend }}"
                            data-wish-attend-list="{{ participant.get_wish_attend_list_ids }}"
                            data-wish-ticket-count="{{ participant.wish_ticket_count }}"
                            data-notes="{{ participant.notes }}"
                            data-project-name="{{ project.name }}"
                            data-project-description="{{ project.description }}"
                            data-event-time-date="{{ participant.event_time.date }}"
                            data-event-time-session="{{ participant.event_time.session }}"
                            data-event-time-start-time="{{ participant.event_time.start_time }}"
                            data-event-time-end-time="{{ participant.event_time.end_time }}"
                            data-event-time-location-name="{{ participant.event_time.location_name }}"
                            data-event-time-location-address="{{ participant.event_time.location_address }}"
                            data-dead-line-date="{{ participant.event_time.get_dead_line_weekday }}"
                            data-event-time-format-date="{{ participant.event_time.format_date_mm_dd }}"
                            data-pp-id="{{ participant.pp_id }}"
                            data-join-people-count="{{ participant.join_people_count }}"
                            data-send-check-email="{{ participant.send_check_email }}"
                            data-get-ticket-check="{{ participant.get_ticket_check }}"
                            >
                                <td style="width: 3%; text-align: center;">
                                    <input type="checkbox" class="form-check-input row-checkbox" {% if participant.get_ticket_check %}checked{% endif %}>
                                </td>
                                <td style="width: 5%; text-align: center;">{{ participant.pp_id }}</td>
                                <td data-bs-toggle="modal" data-bs-target="#vipDetailModal" style="cursor: pointer; width: 6%;">
                                    <span data-bs-toggle="tooltip" data-bs-placement="right" 
                                    title="邀請時間：{{ participant.invited_at|date:"Y/m/d H:i" }}
                                    上次更新時間：{{ participant.last_update_at|date:"Y/m/d H:i" }}" style="cursor: pointer;">
                                    {{ participant.vip.name }}
                                    </span>
                                </td>
                                <td style="width: 6%;">{{ participant.vip.organization }}</td>
                                <td class="d-none d-lg-table-cell" style="width: 7%;">{{ participant.invited_by.profile.nickname }}</td>
                                <td style="width: 8%; text-align: center;">{{ participant.wish_ticket_count }}</td>
                                <td class="d-none d-lg-table-cell" style="width: 14%; text-align: center;">{{ participant.get_status_display }}</td>
                               
                                <td class="d-none d-lg-table-cell" style="width: 6%; text-align: center;">{{ participant.join_people_count }}</td>
                                
                                <td class="d-none d-lg-table-cell" style="width: 5%; text-align: center;">
                                    {% if participant.send_check_email %}
                                        <i class="bi bi-check-circle text-success"></i>
                                    {% else %}
                                        <i class="bi bi-x-circle text-danger"></i>
                                    {% endif %}
                                </td>
                                <td class="d-none d-lg-table-cell"style="width: 5%; text-align: center;">
                                    {% if participant.send_remind_email %}
                                        <i class="bi bi-check-circle text-success"></i>
                                    {% else %}
                                        <i class="bi bi-x-circle text-danger"></i>
                                    {% endif %}
                                </td>
                                <td style="width: 10%;">{{ participant.notes }}</td>
                                <td style="width: 15%; text-align: center;">
                                    <div class="btn-group btn-group-sm " role="group">
                                        <div class="btn-group btn-group-sm dropstart" role="group">
                                            <button type="button" class="btn btn-outline-dark dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="bi bi-envelope"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#emailModal">寄送邀請信</a></li>
                                                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#checkEmailModal">寄送確認信</a></li>
                                                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#remindEmailModal">寄送提醒信</a></li>
                                            </ul>
                                        </div>
                                        <button type = "button" class = "btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#updateModal">
                                            <i class="bi bi-pencil-square"></i>
                                        </button> 
                                        <button type="button" class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#deleteModal">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-center">目前尚未邀請貴賓！</p>
            {% endif %}
            {% if is_paginated %}
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page=1" data-page="{{ page_obj.previous_page_number }}" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                        {% endif %}

                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                                <li class="page-item active"><a class="page-link" href="#">{{ num }}</a></li>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
                            {% endif %}
                        {% endfor %}

                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            {% endif %}
        </div>
    </div>
    <div class="mt-3 d-flex">
        <a href="{% url 'VIPSystem_APP:project_detail' project.pk %}" class="btn btn-outline-secondary">回上層</a>
    </div>
</div>

<!-- 刪除確認 Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" data-bs-backdrop="static" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">確認刪除</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="deleteModalBody"></div>
            <div class="modal-footer" style="display: flex; justify-content: space-between;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <form action="{% url 'VIPSystem_APP:remove_participant_event_time' project.pk event_time.section event_time.pk %}" method="POST" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" id="participant_id" name="participant_id">
                    <button type="submit" class="btn btn-danger">確認刪除</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 寄邀請信 Modal -->
<div class="modal fade" id="emailModal" tabindex="-1" aria-labelledby="emailModalLabel" data-bs-backdrop="static" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="emailModalLabel">寄送邀請信</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'VIPSystem_APP:send_email_event_time' project.pk event_time.section event_time.pk %}" id="emailForm{{ participant.id }}">
                    {% csrf_token %}
                    <div class="form-group mb-3 row">
                        <input type="hidden" id="vip_id" name="vip_id">
                        <label for="recipient_name" class="col-sm-2 col-form-label">收件人名稱</label>
                        <div class="col-sm-3">
                            <input type="text" class="form-control" id="recipient_name" name="recipient_name" required placeholder="請輸入收件人名稱">
                        </div>  
                        <label for="sender" class="col-sm-2 col-form-label">收件人 E-mail</label>
                        <div class="col-sm-5">
                            <input type="email" class="form-control" id="sender" name="sender" required placeholder="請輸入收件人電子郵件">
                        </div>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <h5>邀請場次</h5>
                        <ul class="list-group">
                            <li class="list-group-item" id="eventInfo"></li>
                        </ul>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <h5>信件標題</h5>
                        <input type="text" class="form-control" id="email_title" name="email_title">
                    </div>
                    <hr>
                    <div class="mb-3">
                        <h5>cc對象（預設為邀請人；可輸入多個對象，以半形逗號（,）分隔）</h5>
                        <input type="text" class="form-control" id="email_cc" name="email_cc" required placeholder="請輸入cc對象">
                    </div>
                    <hr>
                    <div class="mb-3">
                        <h5>信件內容</h5>
                        <textarea class="form-control rich_text_editor" id="email_content" name="email_content" rows="3"></textarea>
                    </div>
                    <div class="modal-footer justify-content-between">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">取消</button>     
                        <button type="submit" class="btn btn-dark" id="submitBtn">送出</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 寄確認信 Modal -->
<div class="modal fade" id="checkEmailModal" tabindex="-1" aria-labelledby="checkEmailModalLabel" data-bs-backdrop="static" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="emailModalLabel">寄送確認信</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'VIPSystem_APP:send_check_email_event_time' project.pk event_time.section event_time.pk %}" id="checkEmailForm">
                    {% csrf_token %}
                    <div class="form-group mb-3 row">
                        <input type="hidden" id="check_email_vip_id" name="check_email_vip_id" readonly>
                        <label for="recipient_name" class="col-sm-2 col-form-label">收件人名稱</label>
                        <div class="col-sm-3">
                            <input type="text" class="form-control" id="check_email_recipient_name" name="check_email_recipient_name" required placeholder="請輸入收件人名稱" readonly>
                        </div>  
                        <label for="check_email_sender" class="col-sm-2 col-form-label">收件人 E-mail</label>
                        <div class="col-sm-5">
                            <input type="email" class="form-control" id="check_email_sender" name="check_email_sender" required placeholder="請輸入收件人電子郵件">
                        </div>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <h5>邀請場次</h5>
                        <ul class="list-group">
                            <li class="list-group-item" id="check_email_eventInfo"></li>
                        </ul>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <h5>信件標題</h5>
                        <input type="text" class="form-control" id="check_email_email_title" name="check_email_email_title" required placeholder="請輸入信件標題">
                    </div>
                    <hr>
                    <div class="mb-3">
                        <h5>cc對象（預設為邀請人；可輸入多個對象，以半形逗號（,）分隔）</h5>
                        <input type="text" class="form-control" id="check_email_cc" name="check_email_cc" required placeholder="請輸入cc對象">
                    </div>
                    <hr>
                    <div class="mb-3">
                        <h5>信件內容</h5>
                        <textarea class="form-control rich_text_editor" id="check_email_email_content" name="check_email_email_content" rows="3"></textarea>
                    </div>
                    <div class="modal-footer justify-content-between">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">取消</button>     
                        <button type="submit" class="btn btn-dark" id="check_email_submitBtn">送出</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- 寄提醒信 Modal -->
<div class="modal fade" id="remindEmailModal" tabindex="-1" aria-labelledby="remindEmailModalLabel" data-bs-backdrop="static" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="emailModalLabel">寄送提醒信</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'VIPSystem_APP:send_remind_email_event_time' project.pk event_time.section event_time.pk %}" id="remindEmailForm">
                    {% csrf_token %}
                    <div class="form-group mb-3 row">
                        <input type="hidden" id="remind_email_vip_id" name="remind_email_vip_id" readonly>
                        <label for="recipient_name" class="col-sm-2 col-form-label">收件人名稱</label>
                        <div class="col-sm-3">
                            <input type="text" class="form-control" id="remind_email_recipient_name" name="remind_email_recipient_name" required placeholder="請輸入收件人名稱" readonly>
                        </div>  
                        <label for="remind_email_sender" class="col-sm-2 col-form-label">收件人 E-mail</label>
                        <div class="col-sm-5">
                            <input type="email" class="form-control" id="remind_email_sender" name="remind_email_sender" required placeholder="請輸入收件人電子郵件">
                        </div>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <h5>邀請場次</h5>
                        <ul class="list-group">
                            <li class="list-group-item" id="remind_email_eventInfo"></li>
                        </ul>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <h5>信件標題</h5>
                        <input type="text" class="form-control" id="remind_email_email_title" name="remind_email_email_title" required placeholder="請輸入信件標題">
                    </div>
                    <hr>
                    <div class="mb-3">
                        <h5>cc對象（預設為邀請人；可輸入多個對象，以半形逗號（,）分隔）</h5>
                        <input type="text" class="form-control" id="remind_email_cc" name="remind_email_cc" required placeholder="請輸入cc對象">
                    </div>
                    <hr>
                    <div class="mb-3">
                        <h5>信件內容</h5>
                        <textarea class="form-control rich_text_editor" id="remind_email_email_content" name="remind_email_email_content" rows="3"></textarea>
                    </div>
                    <div class="modal-footer justify-content-between">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">取消</button>     
                        <button type="submit" class="btn btn-dark" id="remind_email_submitBtn">送出</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 篩選姓名 Modal -->
<div class="modal fade" id="filterNameModal" data-bs-backdrop="static" tabindex="-1" aria-labelledby="filterNameModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterNameModalLabel">顯示哪些姓名</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                
                <div class="mb-3">
                    <input type="text" class="form-control" id="nameFilter" name="nameFilter" placeholder="請輸入關鍵字">
                </div>
                
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="applyFilterName()" id="applyFilterNameBtn">篩選</button>
            </div>
        </div>
    </div>
</div>

<!-- 篩選誰邀請 modal-->
<div class="modal fade" id="filterInvitedByModal" tabindex="-1" aria-labelledby="filterInvitedByModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterInvitedByModalLabel">篩選主要邀請人</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex flex-wrap">
                    <form id="filterInvitedByForm">
                        {% for user in staffs %}
                        <input type="checkbox" class="btn-check" value="{{ user.id }}" id="user{{ user.id }}">
                        <label class="btn btn-outline-dark m-1" for="user{{ user.id }}"> {{ user.username }} </label>
                        {% endfor %}
                    </form>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="applyFilterInvitedBy()" id="applyFilterInvitedByBtn">篩選</button>   
            </div>
        </div>
    </div>
</div>

<!-- 篩選單位modal-->
<div class="modal fade" id="filterOrganizationModal" data-bs-backdrop="static" tabindex="-1" aria-labelledby="filterOrganizationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterOrganizationModalLabel">篩選單位</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body"> 
                <div class="mb-3">
                    <input type="text" class="form-control" id="organizationFilter" name="organizationFilter" placeholder="請輸入單位關鍵字">
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="applyFilterOrganization()" id="applyFilterOrganizationBtn">篩選</button>
            </div>
        </div>
    </div>
</div>
<!-- 篩選狀態modal-->
<div class="modal fade" id="filterStatusModal" tabindex="-1" aria-labelledby="filterStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterStatusModalLabel">篩選回復狀態</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" id="filterStatusForm"> 
                    {% csrf_token %}
                    <div class="d-flex flex-wrap">
                        <input type="checkbox" class="btn-check" value="added" id="added">
                        <label class="btn btn-outline-dark m-1" for="added"> 尚未寄出邀請信 </label>
                        <input type="checkbox" class="btn-check" value="confirmed" id="confirmed">
                        <label class="btn btn-outline-dark m-1" for="confirmed"> 確認參加 </label>
                        <input type="checkbox" class="btn-check" value="sended" id="sended">
                        <label class="btn btn-outline-dark m-1" for="sended"> 已發送邀請信件等待回覆 </label>
                        <input type="checkbox" class="btn-check" value="declined" id="declined">
                        <label class="btn btn-outline-dark m-1" for="declined"> 拒絕參加 </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="applyFilterStatus()" id="applyFilterStatusBtn">篩選</button>   
            </div>
        </div>
    </div>
</div>

<!--顯示資訊的 modal-->
<div class="modal fade" id="vipDetailModal" tabindex="-1" aria-labelledby="vipDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="vipDetailModalLabel">貴賓詳細資訊（可由此直接修改）</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="{% url 'VIPSystem_APP:update_vip_info_by_event_time' project.pk event_time.section event_time.pk %}" method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="vipId" id="vipId">
                    <div class="row mb-3">
                      <label class="col-2 col-form-label text-center" style="justify-content: center;" >姓名<span style="color:red;">*</span></label>
                      <div class="col-3">
                        <input id="vipName" type="text" class="form-control" name="name" placeholder="請輸入貴賓姓名" required>
                      </div>
                      <label class="col-3 col-form-label text-center" style="justify-content: center;" >綽號</label>
                      <div class="col-4">
                        <input id="vipNickname" type="text" class="form-control" name="nickname" placeholder="請輸入貴賓綽號">
                      </div>
                    </div>
                    <div class="row mb-3">
                        <label class="col-2 col-form-label text-center" style="justify-content: center;" >單位<span style="color:red;">*</span></label>
                        <div class="col-3">
                          <input id="vipOrganization" type="text" class="form-control" name="organization" placeholder="請輸入貴賓單位" required>
                        </div>
                        <label class="col-3 col-form-label text-center" style="justify-content: center;" >職稱</label>
                        <div class="col-4">
                          <input id="vipPosition" type="text" class="form-control" name="position" placeholder="請輸入貴賓職稱" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <label class="col-2 col-form-label text-center" style="justify-content: center;" >電話<span style="color:red;">*</span></label>
                        <div class="col-3">
                          <input id="vipPhoneNumber" type="text" class="form-control" name="phone_number" placeholder="請輸入貴賓電話" required>
                        </div>
                        <label class="col-3 col-form-label text-center" style="justify-content: center;" >Email</label>
                        <div class="col-4">
                          <input id="vipEmail" type="text" class="form-control" name="email" placeholder="請輸入貴賓Email" required>
                        </div>
                    </div>
                    <div class="modal-footer" style="display: flex; justify-content: space-between;">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                      <button type="submit" class="btn btn-primary">送出更新</button>
                    </div>
                  </form>
            </div>
        </div>
    </div>
</div>

<!-- 修改 Modal -->
<div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" data-bs-backdrop="static">
    {{ event_times_json|json_script:"event-times-data" }}
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateModalLabel"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'VIPSystem_APP:update_participants_info_by_event_time' project.pk event_time.section event_time.pk %}" id="updateForm">
                    {% csrf_token %}
                    <input type="hidden" name="vip_id" id="vip_id">
                    <h6>參與場次修改</h6>
                    <div class="row row-cols-1 row-cols-md-2 g-4" id = "eachEventTimeCheckboxDiv">
                        <div class="col">
                            <label class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title" id="allEventTimeCheckboxDiv"></h5>
                                    <p class="card-text">
                                        選擇此選項表示不特別限定貴賓參與的場次，讓貴賓自由選擇
                                    </p>
                                </div>
                            </label>
                        </div>
                    </div>
                    <hr>
                    <h6>提供票數調整</h6>
                    <div class="row row-cols-1 row-cols-md-2 g-4">
                        <div class="col">
                            <input type="number" class="form-control" name="wish_ticket_count" id="wish_ticket_count" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">取消</button>
                <button type="submit" form="updateForm" class="btn btn-primary" id="confirmEventTime">送出</button>
            </div>
        </div>
    </div>
</div>

<script>
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })

    document.addEventListener('DOMContentLoaded', function() {

        $('.rich_text_editor').summernote({
            height: 300,
            toolbar: [
                // 樣式相關
                ['style', ['style', 'bold', 'italic', 'underline', 'clear']],
                
                // 字體相關
                ['font', ['strikethrough', 'superscript', 'subscript']],
                ['fontname', ['fontname']], // 字體類型
                ['fontsize', ['fontsize']], // 字體大小
                ['color', ['color']],       // 字體顏色
                
                // 段落相關
                ['para', ['ul', 'ol', 'paragraph']],
                ['height', ['height']],     // 行高
                
                // 插入功能
                ['insert', ['link', 'picture', 'table']], // 連結、圖片、表格
                
                // 其他功能
                ['view', ['fullscreen', 'codeview']] // 全螢幕、HTML 原始碼
            ]
        });

        const vipDetailModal = document.getElementById('vipDetailModal');
        // 監聽 vipDetailModal 的 show 事件
        vipDetailModal.addEventListener('show.bs.modal', handleVipDetailModal);

        // 監聽 deleteModal 的 show 事件
        const deleteModal = document.getElementById('deleteModal');
        deleteModal.addEventListener('show.bs.modal', handleDeleteModal);

        // 監聽 emailModal 的 show 事件
        const emailModal = document.getElementById('emailModal');
        emailModal.addEventListener('show.bs.modal', handleEmailModal);


        // 監聽 updateModal 的 show 事件
        const updateModal = document.getElementById('updateModal');
        updateModal.addEventListener('show.bs.modal', handleUpdateModal);
        updateModal.addEventListener('hidden.bs.modal', function () {
            this.removeAttribute('aria-hidden');
        });

        // 監聽 checkEmailModal 的 show 事件
        const checkEmailModal = document.getElementById('checkEmailModal');
        checkEmailModal.addEventListener('show.bs.modal', handleCheckEmailModal);

        // 監聽 remindEmailModal 的 show 事件
        const remindEmailModal = document.getElementById('remindEmailModal');
        remindEmailModal.addEventListener('show.bs.modal', handleRemindEmailModal);

        handleUpdateGetTicketCheck();

    });

    function handleRemindEmailModal(event) {
        const remindEmailModal = document.getElementById('remindEmailModal');
        const trigger = event.relatedTarget;
        const parentRow = trigger.closest('.vip-row');
        if (parentRow) {
            remindEmailModal.querySelector('#remind_email_recipient_name').value = parentRow.dataset.vipName;
            remindEmailModal.querySelector('#remind_email_vip_id').value = parentRow.dataset.vipId;
            remindEmailModal.querySelector('#remind_email_sender').value = parentRow.dataset.vipEmail;
            remindEmailModal.querySelector('#remind_email_cc').value = parentRow.dataset.invitedByEmail;
            remindEmailModal.querySelector('#remind_email_eventInfo').innerHTML = `
                <strong>${parentRow.dataset.eventTimeDate} ${parentRow.dataset.eventTimeSession}</strong>
                <br>
                <small>
                    時間：${parentRow.dataset.eventTimeStartTime} - ${parentRow.dataset.eventTimeEndTime} | 
                    地點：${parentRow.dataset.eventTimeLocationName} | 
                    地址：${parentRow.dataset.eventTimeLocationAddress}
                </small>
            `;
            remindEmailModal.querySelector('#remind_email_email_title').value = `【出席提醒信】《${parentRow.dataset.projectName}》${parentRow.dataset.eventTimeFormatDate} - 薩泰爾娛樂`;
            const emailTemplate = `
                <h4 style="font-size: 24px; font-weight: bold; margin-bottom: 10px;">${parentRow.dataset.vipName} 您好：</h4>
                <p>《${parentRow.dataset.projectName} ${parentRow.dataset.eventTimeSession}》就要在明天舉行了！提醒您將以下活動及進場資訊截圖保存於手機中，以利加速進場流程</p>
                <p>期待您蒞臨觀賞，謝謝！</p>
                <p style="margin-top: 20px;">
                    ◉ 取票序號：<strong style="color: darkred;">${parentRow.dataset.ppId}</strong><br><br>
                    ◉ 貴賓資訊：<strong>${parentRow.dataset.vipOrganization} ${parentRow.dataset.vipName}</strong>（邀請人：<strong>${parentRow.dataset.invitedBy}</strong>）<br><br>
                    ◉ 取票數量：<strong style="color: darkred;">${parentRow.dataset.wishTicketCount}</strong><br><br>
                    ◉ 取票位置：<strong>壹電視攝影棚入口公關取票桌</strong><br><br>
                    ◉ 取票方式：至公關取票桌出示本【出席確認信】的取票資訊
                </p>

                <p>
                    <strong>【活動資訊】</strong><br>
                    演出日期：<strong>${parentRow.dataset.eventTimeDate}</strong><br>
                    場館地址：<strong>壹電視攝影棚 (台北市內湖區新湖二路146巷18號)</strong><br>
                    進場時間：<strong>17:00 - 18:00</strong>（若您超過18:00進場，需要按照現場人員指示進場）<br>
                    演出時間：<strong>18:00 - 21:00</strong>
                </p>

                <p style="margin-top: 20px;">
                    若有任何問題請不吝聯繫邀請您的夥伴或以下窗口
                </p>

                <p>
                    <strong>【${parentRow.dataset.projectName}】禮賓統籌</strong><br>
                    游幃傑 Jerry Yu<br>
                    jerryyu@strnetwork.cc<br>
                    0924-109-008
                </p>

                <p>
                    敬祝 平安順心<br>
                    薩泰爾娛樂 敬上
                </p>

                <h3>▶ 現場注意事項</h3>
                <ol>
                    <li>本節目錄影全長約 110 至 140 分鐘（含中場休息）。遲到觀眾須於主辦單位安排之時間點，在工作人員的引導之下入場，不得異議。</li>
                    <li>未經主辦單位同意，場內禁止錄影、錄音、拍照、限時動態。</li>
                    <li>主辦單位未公開節目內容前，需對內容完全保密。</li>
                    <li>本節目禁止攜帶外食、飲料、任何種類之金屬、玻璃、雷射筆、煙火或任何危險物品。</li>
                    <li>本節目無尺度限制，18 歲以下觀眾建議由成年人陪同觀賞。</li>
                    <li>全場次皆為錄影場，入場即代表您同意個人肖像權可作為薩泰爾娛樂股份有限公司 -【 賀瓏夜夜秀 】使用。</li>
                    <li>全場次皆為現場錄影，攝影機架設、移動尊重現場導播指示，如有部分阻擋視線敬請見諒。</li>
                </ol>
            `;
            $('#remind_email_email_content').summernote('code', emailTemplate);
        }
    }

    function handleCheckEmailModal(event) {
        const checkEmailModal = document.getElementById('checkEmailModal');
        const trigger = event.relatedTarget;
        const parentRow = trigger.closest('.vip-row');
        if (parentRow) {
            checkEmailModal.querySelector('#check_email_recipient_name').value = parentRow.dataset.vipName;
            checkEmailModal.querySelector('#check_email_vip_id').value = parentRow.dataset.vipId;
            checkEmailModal.querySelector('#check_email_sender').value = parentRow.dataset.vipEmail;
            checkEmailModal.querySelector('#check_email_cc').value = parentRow.dataset.invitedByEmail;
            checkEmailModal.querySelector('#check_email_eventInfo').innerHTML = `
                <strong>${parentRow.dataset.eventTimeDate} ${parentRow.dataset.eventTimeSession}</strong>
                <br>
                <small>
                    時間：${parentRow.dataset.eventTimeStartTime} - ${parentRow.dataset.eventTimeEndTime} | 
                    地點：${parentRow.dataset.eventTimeLocationName} | 
                    地址：${parentRow.dataset.eventTimeLocationAddress}
                </small>
            `;
            checkEmailModal.querySelector('#check_email_email_title').value = `【出席確認信】《${parentRow.dataset.projectName}》${parentRow.dataset.eventTimeFormatDate} - 薩泰爾娛樂`;
            const emailTemplate = `
                    <h4 style="font-size: 24px; font-weight: bold; margin-bottom: 10px;">親愛的${parentRow.dataset.vipName} 您好：</h4>

                    <p>
                        感謝您撥空參與薩泰爾娛樂 - 《${parentRow.dataset.projectName}》
                    </p>

                    <p>
                        本信件用於核對現場取票資訊，請保留至演出結束，<strong style="color: darkred;">建議您將以下資訊截圖保存，以利加速取票流程。</strong>
                    </p>

                    <p>期待您蒞臨觀賞，謝謝！</p>

                    <p style="margin-top: 20px;">
                        ◉ 取票序號：<strong style="color: darkred;">${parentRow.dataset.ppId}</strong><br><br>
                        ◉ 貴賓資訊：<strong>${parentRow.dataset.vipOrganization} ${parentRow.dataset.vipName}</strong>（邀請人：<strong>${parentRow.dataset.invitedBy}</strong>）<br><br>
                        ◉ 取票數量：<strong style="color: darkred;">${parentRow.dataset.wishTicketCount}</strong><br><br>
                        ◉ 取票位置：<strong>壹電視攝影棚入口公關取票桌</strong><br><br>
                        ◉ 取票方式：至公關取票桌出示本【出席確認信】的取票資訊
                    </p>

                    <p>
                        <strong>【活動資訊】</strong><br>
                        演出日期：<strong>${parentRow.dataset.eventTimeDate}</strong><br>
                        場館地址：<strong>壹電視攝影棚 (台北市內湖區新湖二路146巷18號)</strong><br>
                        進場時間：<strong>17:00 - 18:00</strong>（若您超過18:00進場，需要按照現場人員指示進場）<br>
                        演出時間：<strong>18:00 - 21:00</strong>
                    </p>

                    <p style="margin-top: 20px;">
                        若有任何問題請不吝聯繫邀請您的夥伴或以下窗口
                    </p>

                    <p>
                        <strong>【${parentRow.dataset.projectName}】禮賓統籌</strong><br>
                        游幃傑 Jerry Yu<br>
                        jerryyu@strnetwork.cc<br>
                        0924-109-008
                    </p>

                    <p>
                        敬祝 平安順心<br>
                        薩泰爾娛樂 敬上
                    </p>

                    <h3>▶ 現場注意事項</h3>
                    <ol>
                        <li>本節目錄影全長約 110 至 140 分鐘（含中場休息）。遲到觀眾須於主辦單位安排之時間點，在工作人員的引導之下入場，不得異議。</li>
                        <li>未經主辦單位同意，場內禁止錄影、錄音、拍照、限時動態。</li>
                        <li>主辦單位未公開節目內容前，需對內容完全保密。</li>
                        <li>本節目禁止攜帶外食、飲料、任何種類之金屬、玻璃、雷射筆、煙火或任何危險物品。</li>
                        <li>本節目無尺度限制，18 歲以下觀眾建議由成年人陪同觀賞。</li>
                        <li>全場次皆為錄影場，入場即代表您同意個人肖像權可作為薩泰爾娛樂股份有限公司 -【 賀瓏夜夜秀 】使用。</li>
                        <li>全場次皆為現場錄影，攝影機架設、移動尊重現場導播指示，如有部分阻擋視線敬請見諒。</li>
                    </ol>
                    `;
            $('#check_email_email_content').summernote('code', emailTemplate);
        };

        // 設置表單提交事件
        const checkEmailForm = document.getElementById('checkEmailForm');
        checkEmailForm.addEventListener('submit', function(e) {
            var check_email_submitBtn = e.target.querySelector('#check_email_submitBtn');
            check_email_submitBtn.disabled = true;
            check_email_submitBtn.innerHTML = ' <span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span> 寄件中請稍候';
        });
    }

    function handleUpdateModal(event) {
        const updateModal = document.getElementById('updateModal');
        const trigger = event.relatedTarget;
        const parentRow = trigger.closest('.vip-row');
        if (parentRow) {
            const eachEventTimeCheckboxDiv = updateModal.querySelector('#eachEventTimeCheckboxDiv');
            eachEventTimeCheckboxDiv.innerHTML = '';
            updateModal.querySelector('#updateModalLabel').innerHTML = `修改 ${parentRow.dataset.vipName} 的參與資訊`;
            updateModal.querySelector('#vip_id').value = parentRow.dataset.vipId;
            const wishAttend = parentRow.dataset.wishAttend?.split(',') || [];
            const wishAttendList = parentRow.dataset.wishAttendList;
            const checkedAll = wishAttend.includes('all') ? 'checked' : '';
            eachEventTimeCheckboxDiv.insertAdjacentHTML('beforeend',`
            <div class="col">   
                <label class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">
                            <input type="checkbox" 
                            name="selected_event_time_by_section" 
                            value="all" 
                            class="form-check-input me-2 selectAll" 
                            id="selectAll" 
                            form="updateForm"
                            ${checkedAll}>
                        都可以
                        </h5>
                        <p class="card-text">
                            選擇此選項表示不特別限定貴賓參與的場次，讓貴賓自由選擇
                        </p>
                    </div>
                </label>
            </div>
            `);
            
            const eventTimes = JSON.parse(document.getElementById('event-times-data').textContent);
            eventTimes.forEach(eventTime => {
                const isChecked = wishAttendList.includes(eventTime.id) ? 'checked' : '';
                eachEventTimeCheckboxDiv.insertAdjacentHTML('beforeend', `
                    <div class="col">
                        <label class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <input form="updateForm" 
                                        type="checkbox" 
                                        name="selected_event_time_by_section" 
                                        value="${eventTime.id}" 
                                        class="form-check-input me-2 event-time-checkbox"
                                        ${isChecked}>
                                    ${eventTime.date} ${eventTime.section}${eventTime.session}
                                </h5>
                                <p class="card-text">
                                    時間：${eventTime.start_time} - ${eventTime.end_time}<br>
                                    地點：${eventTime.location_name}<br>
                                    地址：${eventTime.location_address}
                                </p>
                            </div>
                        </label>
                    </div>
                `);
            });

            var wishTicketCount = parentRow.dataset.wishTicketCount;
            updateModal.querySelector('#wish_ticket_count').value = wishTicketCount;
        }
    }

    function handleEmailModal(event) {
        const trigger = event.relatedTarget;
        const parentRow = trigger.closest('.vip-row');
        if (parentRow) {
            document.getElementById('recipient_name').value = parentRow.dataset.vipName;
            document.getElementById('vip_id').value = parentRow.dataset.vipId;
            document.getElementById('sender').value = parentRow.dataset.vipEmail;
            document.getElementById('email_title').value = `【薩泰爾娛樂】《${parentRow.dataset.projectName}》合作夥伴現場觀賞邀請`;
            document.getElementById('email_cc').value = parentRow.dataset.invitedByEmail;
            if (parentRow.dataset.status == '尚未寄出邀請信' || parentRow.dataset.status == '已發送邀請信件等待回覆') {
                var ticket_count = parentRow.dataset.wishTicketCount;
            } else {
                var ticket_count = parentRow.dataset.joinPeopleCount;
            }
            // 建立 Email 完整模板
            const emailTemplate = `
                <h4 class="mb-3" style="font-size: 24px; font-weight: bold;">親愛的${parentRow.dataset.vipName} 您好：</h4>
                
                <p>感謝您一路以來對薩泰爾娛樂的支持，<br>
                我們將於 <strong style="color:darkred;">${parentRow.dataset.eventTimeDate}</strong> 舉辦<strong>【${parentRow.dataset.projectName} ${parentRow.dataset.eventTimeSession}】的錄影活動</strong></p>

                <p>請於下方連結中填寫資料，敬請於 <strong style="color:darkred;">${parentRow.dataset.deadLineDate}</strong> 前填寫完成，期待您的蒞臨！</p>

                <p><a href="#">☞點擊按鈕確認參加！</a></p>

                <p>活動日期：<strong>${parentRow.dataset.eventTimeDate}</strong><br>
                場館地址：<strong>壹電視攝影棚 (台北市內湖區新湖二路146巷18號)</strong><br>
                進場時間：<strong>17:00 - 18:00</strong><br>
                演出時間：<strong>18:00 - 21:00</strong></p>

                <p>填寫時麻煩留意以下資訊：
                <ul>
                    <li>出席人數以 <strong style="color:darkred;">${ticket_count}</strong> 人為限</li>
                    <li>報名成功後，薩泰爾娛樂最晚將於一週內寄出電子「出席確認信」，若逾期仍未收到「出席確認信」，請儘速與邀請您的夥伴或禮賓統籌聯繫。</li>
                </ul></p>

                <p><strong>【${parentRow.dataset.projectName}】禮賓統籌</strong><br>
                游幃傑 Jerry Yu<br>
                jerryyu@strnetwork.cc<br>
                0924-109-008</p>

                <p>保留席有限，敬請把握登記！</p>
                <p>薩泰爾娛樂 敬上</p>

                <h3>▶現場注意事項</h3>
                <ol>
                    <li>本節目錄影全長約 110 至 140 分鐘（含中場休息）。遲到觀眾須於主辦單位安排之時間點，在工作人員的引導之下入場，不得異議。</li>
                    <li>未經主辦單位同意，場內禁止錄影、錄音、拍照、限時動態。</li>
                    <li>主辦單位未公開節目內容前，需對內容完全保密。</li>
                    <li>本節目禁止攜帶外食、飲料、任何種類之金屬、玻璃、雷射筆、煙火或任何危險物品。</li>
                    <li>本節目無尺度限制，18 歲以下觀眾建議由成年人陪同觀賞。</li>
                    <li>全場次皆為錄影場，入場即代表您同意個人肖像權可作為薩泰爾娛樂股份有限公司 -【 賀瓏夜夜秀 】使用。</li>
                    <li>全場次皆為現場錄影，攝影機架設、移動尊重現場導播指示，如有部分阻擋視線敬請見諒。</li>
                </ol>
            `;

            // 將模板注入編輯器
            $('#email_content').summernote('code', emailTemplate);

            document.getElementById('eventInfo').innerHTML = `
                <strong>${parentRow.dataset.eventTimeDate} ${parentRow.dataset.eventTimeSession}</strong>
                <br>
                <small>
                    時間：${parentRow.dataset.eventTimeStartTime} - ${parentRow.dataset.eventTimeEndTime} | 
                    地點：${parentRow.dataset.eventTimeLocationName} | 
                    地址：${parentRow.dataset.eventTimeLocationAddress}
                </small>
            `;
        };

        // 設置表單提交事件
        const emailForm = document.getElementById('emailForm');
        emailForm.addEventListener('submit', function(e) {
            var submitBtn = e.target.querySelector('#submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = ' <span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span> 寄件中請稍候';
        });
    }

    function handleDeleteModal(event) {
        const trigger = event.relatedTarget;
        const parentRow = trigger.closest('.vip-row');
        if (parentRow) {
            document.getElementById('deleteModalBody').innerHTML = `您確定要刪除 <strong>${parentRow.dataset.vipName}</strong> 嗎？`;
            document.getElementById('participant_id').value = parentRow.dataset.vipId;
        }
    }

    function handleVipDetailModal(event) {
        const trigger = event.relatedTarget;
        const parentRow = trigger.closest('.vip-row');
        
        if (parentRow) {
            const vipDetailModal = document.getElementById('vipDetailModal');
            vipDetailModal.querySelector('#vipId').value = parentRow.dataset.vipId;
            vipDetailModal.querySelector('#vipName').value = parentRow.dataset.vipName;
            vipDetailModal.querySelector('#vipNickname').value = parentRow.dataset.vipNickname;
            vipDetailModal.querySelector('#vipOrganization').value = parentRow.dataset.vipOrganization;
            vipDetailModal.querySelector('#vipPosition').value = parentRow.dataset.vipPosition;
            vipDetailModal.querySelector('#vipPhoneNumber').value = parentRow.dataset.vipPhoneNumber;
            vipDetailModal.querySelector('#vipEmail').value = parentRow.dataset.vipEmail;
        };
    }

    function applyFilterName() {
        var nameFilter = document.getElementById('nameFilter').value;
        var url = new URL(window.location.href);
        if (nameFilter == '') {
            url.searchParams.delete('nameFilter');
        } else {
            url.searchParams.set('nameFilter', nameFilter);
        }
        // 重置頁碼到第一頁
        url.searchParams.set('page', 1);
        window.location.href = url.toString();
    }

    function applyFilterInvitedBy() {
        var selectedInvitedBy = [];
        var checkboxes = document.querySelectorAll('#filterInvitedByForm input[type="checkbox"]:checked');
        checkboxes.forEach(function(checkbox) {
            selectedInvitedBy.push(checkbox.value);
        });
        var url = new URL(window.location.href);
        url.searchParams.delete('filter_invited_by');
        selectedInvitedBy.forEach(function(staff_id) {
            url.searchParams.append('filter_invited_by', staff_id);
        });
        // 重置頁碼到第一頁
        url.searchParams.set('page', 1);
        window.location.href = url.toString();
    }

    function applyFilterStatus() {
        var selectedStatus = [];
        var checkboxes = document.querySelectorAll('#filterStatusForm input[type="checkbox"]:checked');
        checkboxes.forEach(function(checkbox) {
            selectedStatus.push(checkbox.value);
        });
        var url = new URL(window.location.href);
        url.searchParams.delete('filter_status');
        selectedStatus.forEach(function(status) {
            url.searchParams.append('filter_status', status);
        });
        // 重置頁碼到第一頁
        url.searchParams.set('page', 1);
        window.location.href = url.toString();
    }

    function applyFilterOrganization() {
        var organizationFilter = document.getElementById('organizationFilter').value;
        var url = new URL(window.location.href);
        if (organizationFilter == '') {
            url.searchParams.delete('organizationFilter');
        } else {
            url.searchParams.set('organizationFilter', organizationFilter);
        }
        window.location.href = url.toString();
    }


    const eventTimeId = '{{ event_time.pk }}';
    const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    const vipSocket = new WebSocket(
        protocol + window.location.host + '/ws/vip-updates/' + eventTimeId + '/'
    );

    vipSocket.onopen = function(e) {
        console.log('VIP WebSocket connected');
    };

    vipSocket.onmessage = function(e) {
        console.log('有喔！');
        const data = JSON.parse(e.data);
        if (data.type === 'vip_update') {
            updateVIPTable(data.participation, data.pp_id);
        }
    };

    function updateVIPTable(participation, pp_id) {
        const tbody = document.querySelector('table tbody');
        const existingRows = tbody.getElementsByClassName('vip-row');
        
        // 將現有行轉換為 Map
        const existingRowsMap = new Map();
        Array.from(existingRows).forEach(row => {
            existingRowsMap.set(row.getAttribute('data-pp-id'), row);
        });
        const existingRow = existingRowsMap.get(pp_id.toString());
        if (existingRow) {
            // 如果行已存在且內容有變化，進行更新
            if (hasChanged(existingRow, participation)) {
                existingRow.replaceWith(createRow(participation));
            }
        };
    }

    function hasChanged(existingRow, newData) {
    // 檢查確認信和提醒信的圖標狀態
    const getTicketCheck = existingRow.querySelector('td:nth-child(1) .form-check-input').checked;
    const hasCheckEmailIcon = existingRow.querySelector('td:nth-child(8) .bi-check-circle') !== null;
    const hasRemindEmailIcon = existingRow.querySelector('td:nth-child(9) .bi-check-circle') !== null;

    return (
        getTicketCheck !== newData.get_ticket_check ||
        existingRow.querySelector('td:nth-child(3)').textContent.trim() !== newData.vip__name ||
        existingRow.querySelector('td:nth-child(4)').textContent.trim() !== newData.vip__organization ||
        existingRow.querySelector('td:nth-child(5)').textContent.trim() !== newData.invited_by__username ||
        existingRow.querySelector('td:nth-child(6)').textContent.trim() !== newData.wish_ticket_count.toString() ||
        existingRow.querySelector('td:nth-child(7)').textContent.trim() !== newData.status ||
        existingRow.querySelector('td:nth-child(8)').textContent.trim() !== newData.join_people_count.toString() ||
        hasCheckEmailIcon !== newData.send_check_email ||
        hasRemindEmailIcon !== newData.send_remind_email ||
        existingRow.querySelector('td:nth-child(11)').textContent.trim() !== newData.notes
    );
    }

    function createRow(participant) {
        const tr = document.createElement('tr');
        tr.className = 'vip-row';
        
        const dataAttributes = {
            'data-vip-name': participant.vip__name,
            'data-vip-id': participant.vip__id,
            'data-vip-nickname': participant.vip__nickname,
            'data-vip-organization': participant.vip__organization,
            'data-vip-position': participant.vip__position,
            'data-vip-phone-number': participant.vip__phone_number,
            'data-vip-email': participant.vip__email,
            'data-status': participant.status,
            'data-invited-by': participant.invited_by__username,
            'data-invited-by-email': participant.invited_by__email,
            'data-wish-attend': participant.wish_attend,
            'data-wish-attend-list': participant.wish_attend_list,
            'data-wish-ticket-count': participant.wish_ticket_count,
            'data-notes': participant.notes,
            'data-project-name': participant.project_name,
            'data-project-description': participant.project_description,
            'data-event-time-date': participant.event_time_date,
            'data-event-time-session': participant.event_time_session,
            'data-event-time-start-time': participant.event_time_start_time,
            'data-event-time-end-time': participant.event_time_end_time,
            'data-event-time-location-name': participant.event_time_location_name,
            'data-event-time-location-address': participant.event_time_location_address,
            'data-dead-line-date': participant.dead_line_date,
            'data-event-time-format-date': participant.event_time_format_date,
            'data-pp-id': participant.pp_id,
            'data-join-people-count': participant.join_people_count,
            'data-send-check-email': participant.send_check_email,
            'data-get-ticket-check': participant.get_ticket_check,
        };

        
        Object.entries(dataAttributes).forEach(([key, value]) => {
            tr.setAttribute(key, value);
        });
        
        tr.innerHTML = `
            <td style="width: 3%; text-align: center;">
                <input type="checkbox" class="form-check-input row-checkbox" ${participant.get_ticket_check ? 'checked' : ''}>
            </td>
            <td style="width: 5%; text-align: center;">${participant.pp_id}</td>
            <td data-bs-toggle="modal" data-bs-target="#vipDetailModal" style="cursor: pointer; width: 6%;">
                <span data-bs-toggle="tooltip" data-bs-placement="right" title="邀請時間：${participant.invited_at}
                上次更新時間：${participant.last_update_at}" style="cursor: pointer;">
                    ${participant.vip__name}
                </span>
            </td>
            <td style="width: 6%;">${participant.vip__organization}</td>
            <td class="d-none d-lg-table-cell" style="width: 6%;">${participant.invited_by__username}</td>
            <td style="width: 8%; text-align: center;">${participant.wish_ticket_count}</td>
            <td class="d-none d-lg-table-cell" style="width: 14%; text-align: center;">${participant.status}</td>
            <td class="d-none d-lg-table-cell" style="width: 6%; text-align: center;">${participant.join_people_count}</td>
            <td class="d-none d-lg-table-cell" style="width: 5%; text-align: center;">
                ${participant.send_check_email ? '<i class="bi bi-check-circle text-success"></i>' : '<i class="bi bi-x-circle text-danger"></i>'}
            </td>
            <td class="d-none d-lg-table-cell" style="width: 5%; text-align: center;">
                ${participant.send_remind_email ? '<i class="bi bi-check-circle text-success"></i>' : '<i class="bi bi-x-circle text-danger"></i>'}
            </td>
            <td style="width: 10%;">${participant.notes}</td>
            <td style="width: 15%; text-align: center;">
                <div class="btn-group btn-group-sm" role="group">
                    <div class="btn-group btn-group-sm dropstart" role="group">
                        <button type="button" class="btn btn-outline-dark dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-envelope"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#emailModal">寄送邀請信</a></li>
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#checkEmailModal">寄送確認信</a></li>
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#reminderModal">寄送提醒信</a></li>
                        </ul>
                    </div>
                    <button type="button" class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#updateModal">
                        <i class="bi bi-pencil-square"></i>
                    </button>
                    <button type="button" class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#deleteModal">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </td>
        `;
        const tooltips = tr.querySelectorAll('[data-bs-toggle="tooltip"]');
        tooltips.forEach(element => {
            new bootstrap.Tooltip(element);
        });

        return tr;
    }

    function handleUpdateGetTicketCheck() {
        // 找到表格或其父容器
        const container = document.querySelector('.table'); // 或其他合適的選擇器
        
        container.addEventListener('change', function(e) {
            // 確保事件來自核取方塊
            if (!e.target.matches('.row-checkbox')) {
                return;
            }

            const checkbox = e.target;
            const row = checkbox.closest('.vip-row');
            const participantId = row.dataset.vipId;
            const isChecked = checkbox.checked;
            
            // 從當前 URL 獲取必要參數
            const currentPath = window.location.pathname;
            const pathParts = currentPath.split('/');
            const projectId = pathParts[3];
            const section = pathParts[4];
            const eventTimeId = pathParts[6];
            
            // 準備表單數據
            const formData = new FormData();
            formData.append('is_checked', isChecked);
            formData.append('participant_id', participantId);
            
            // 發送 AJAX 請求
            fetch(`/VIPSystem_APP/project_list/${projectId}/${section}/event_time/${eventTimeId}/update_get_ticket_check/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status !== 'success') {
                    checkbox.checked = !isChecked;
                    console.error('Update failed:', data.message);
                }
            })
            .catch(error => {
                checkbox.checked = !isChecked;
                console.error('Error:', error);
            });
        });
    }
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

</script>
{% endblock %}
