{% extends "base.html" %}
{% block title %}專案詳細資料{% endblock %}
{% block content %}
<style>
    .pagination .page-link {
        color: #343a40; /* 字體顏色 */
        background-color: transparent; /* 背景透明 */
        border: 1px solid #343a40; /* 黑色邊框 */
    }

    .pagination .page-item.active .page-link {
        color: #fff; /* 活動狀態下的字體顏色 */
        background-color: #343a40; /* 活動狀態下的背景顏色 */
        border-color: #343a40; /* 活動狀態下的邊框顏色 */
    }

    .pagination .page-link:hover {
        color: #fff; /* 懸停時的字體顏色 */
        background-color: #495057; /* 懸停時的背景顏色 */
        border-color: #495057; /* 懸停時的邊框顏色 */
    }
</style>
{% if messages %}
    <div class="container mt-4" id="message-container">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    <script>
        setTimeout(function() {
            const container = document.getElementById('message-container');
            if (container) {
                container.remove();
            }
        }, 3000);
</script>
{% endif %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header bg-dark text-white">
            <h2 class="mb-0">{{ project.description }}《{{ project.name }}》{{event_time.date}} {{event_time.session}}</h2>
        </div>
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">貴賓邀請名單</h3>
                <div class="d-flex justify-content-around gap-3">

                    <div class="card text-center" style="width: 10rem;">
                        <div class="card-body">
                            <h5 class="card-title">已邀請組數</h5>
                            <p class="card-text">{{invited_amount}} 組</p>
                        </div>
                    </div>
                    <div class="card text-center" style="width: 10rem;">
                        <div class="card-body">
                            <h5 class="card-title">可使用票數</h5>
                            <p class="card-text">
                                {% if ticket_count != 0 %}
                                    {{ticket_count}} 張
                                    
                                {% else %}
                                    無可使用票數
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    <div class="card text-center" style="width: 10rem;">
                        <div class="card-body">
                            <h5 class="card-title">已使用票數</h5>
                            <p class="card-text">{{invited_ticket_count}} 張</p>
                        </div>
                    </div>
                    <div class="card text-center" style="width: 10rem;">
                        <div class="card-body">
                            <h5 class="card-title">剩餘票數</h5>
                            <p class="card-text">{{remaining_ticket_count}} 張</p>
                        </div>
                    </div>
                </div>
                <div class="btn-group" role="group">
                    <button id="btnGroupDrop1" type="button" class="btn btn-outline-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                      貴賓名單操作
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="btnGroupDrop1">
                      <li><a href="{% url 'VIPSystem_APP:invite_list_event_time' project.pk event_time.section event_time.pk %}" class="dropdown-item">從資料庫新增貴賓</a></li>
                      <li><a href="#" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#addParticipantDirectlyModal">直接新增貴賓</a></li>
                      <li><a href="{% url 'VIPSystem_APP:send_emails_list_event_time' project.pk event_time.pk %}" class="dropdown-item">批量寄出邀請信</a></li>
                    </ul>
                </div>
            </div>
            <!-- 直接新增貴賓 Modal -->
            <div class="modal fade" id="addParticipantDirectlyModal" data-bs-backdrop="static"tabindex="-1" aria-labelledby="addParticipantDirectlyModalLabel" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="addParticipantDirectlyModalLabel">直接新增貴賓</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body"> 
                    <form action="{% url 'VIPSystem_APP:update_participants_event_time_directly' project.pk event_time.section event_time.pk %}" method="POST">
                      {% csrf_token %}
                      <div class="row mb-3">
                        <label class="col-sm-4 col-form-label text-center" style="justify-content: center;" >貴賓姓名<span style="color: red;">*</span></label>
                        <div class="col-sm-8">
                          <input type="text" class="form-control" name="name" placeholder="請輸入貴賓姓名" required>
                        </div>
                      </div>
                      <div class="row mb-3">
                        <label class="col-sm-4 col-form-label text-center" style="justify-content: center;" >貴賓暱稱</label>
                        <div class="col-sm-8">
                          <input type="text" class="form-control" name="nickname" placeholder="請輸入貴賓暱稱">
                        </div>
                      </div>
                      <div class="row mb-3">
                        <label class="col-sm-4 col-form-label text-center" style="justify-content: center;" >貴賓單位</label>
                        <div class="col-sm-8">
                          <input type="text" class="form-control" name="organization" placeholder="請輸入貴賓單位">
                        </div>
                      </div>
                      <div class="row mb-3">
                        <label class="col-sm-4 col-form-label text-center" style="justify-content: center;" >貴賓職稱</label>
                        <div class="col-sm-8">
                          <input type="text" class="form-control" name="position" placeholder="請輸入貴賓職稱">
                        </div>
                      </div>
                      <div class="row mb-3">
                        <label class="col-sm-4 col-form-label text-center" style="justify-content: center;" >貴賓電話<span style="color: red;">*</span></label>
                        <div class="col-sm-8">
                          <input type="tel" class="form-control" name="phone" placeholder="請輸入貴賓電話" required>
                        </div>
                      </div>
                      <div class="row mb-3">
                        <label class="col-sm-4 col-form-label text-center" style="justify-content: center;" >貴賓電子信箱<span style="color: red;">*</span></label>
                        <div class="col-sm-8">
                          <input type="email" class="form-control" name="email" placeholder="請輸入貴賓電子信箱" required>
                        </div>
                      </div>
                      <div class="row mb-3">
                        <label class="col-sm-4 col-form-label text-center" style="justify-content: center;" >STR 聯絡人<span style="color: red;">*</span></label>
                        <div class="col-sm-8">
                          <input type="text" class="form-control" name="str_connect" placeholder="請輸入 STR 聯絡人" required>
                        </div>
                      </div>
                      <div class="row mb-3">
                        <label class="col-sm-4 col-form-label text-center" style="justify-content: center;" >備註</label>
                        <div class="col-sm-8">
                          <input type="text" class="form-control" name="notes" placeholder="備註">
                        </div>
                      </div>
                      <div class="row mb-3">
                        <label class="col-sm-4 col-form-label text-center" style="justify-content: center;" >提供票數<span style="color: red;">*</span></label>
                        <div class="col-sm-8">
                          <input type="number" class="form-control" name="wish_ticket_count" placeholder="請輸入提供票數" min="1" required>
                        </div>
                      </div>
                      <hr>
                      <h6>聯繫人資訊（若貴賓聯繫人非本人才需要填以下資訊）</h6>
                      <div class="row mb-3">
                        <label class="col-sm-4 col-form-label text-center" style="justify-content: center;" >聯繫人姓名</label>
                        <div class="col-sm-8">
                          <input type="text" class="form-control" name="poc" placeholder="請輸入聯繫人姓名">
                        </div>
                      </div>
                      <div class="row mb-3">
                        <label class="col-sm-4 col-form-label text-center" style="justify-content: center;" >聯繫人職稱</label>
                        <div class="col-sm-8">
                          <input type="text" class="form-control" name="poc_position" placeholder="請輸入聯繫人職稱">
                        </div>
                      </div>
                      <div class="row mb-3">
                        <label class="col-sm-4 col-form-label text-center" style="justify-content: center;" >聯繫人電話</label>
                        <div class="col-sm-8">
                          <input type="tel" class="form-control" name="poc_phone_number" placeholder="請輸入聯繫人電話">
                        </div>
                      </div>
                      <div class="row mb-3">
                        <label class="col-sm-4 col-form-label text-center" style="justify-content: center;" >聯繫人電子信箱</label>
                        <div class="col-sm-8">
                          <input type="email" class="form-control" name="poc_email" placeholder="請輸入聯繫人電子信箱">
                        </div>
                      </div>
                      <div class="modal-footer" style="display: flex; justify-content: space-between;">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="submit" class="btn btn-primary">新增</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
            {% if participants_list %}
                <div style="max-height: 70vh; overflow-y: auto;">
                    <table class="table table-striped mt-3">
                        <thead style="position: sticky; top: 0; background-color: white; z-index: 1;">
                            <tr>
                                <th style="width:  5%; text-align: center;">序號</th>
                                <th style="width:  6%;">姓名 <i class="bi bi-search" data-bs-toggle="modal" data-bs-target="#filterNameModal" style="cursor: pointer;"></i></th>
                                <th style="width:  8%;">單位 <i class="bi bi-search" data-bs-toggle="modal" data-bs-target="#filterOrganizationModal" style="cursor: pointer;"></i></th>
                                <th style="width:  6%;">邀請人 <i class="bi bi-funnel" data-bs-toggle="modal" data-bs-target="#filterInvitedByModal" style="cursor: pointer;"></i></th>
                                <th style="width:  6%; text-align: center;">提供票數</th>
                                <th style="width: 14%; text-align: center;">信件回覆狀態 <i class="bi bi-funnel" data-bs-toggle="modal" data-bs-target="#filterStatusModal" style="cursor: pointer;"></i></th>
                                <th style="width:  6%; text-align: center;">索取票數</th>
                                <th style="width:  5%; text-align: center;">確認信</th>
                                <th style="width:  5%; text-align: center;">提醒信</th>
                                <th style="width: 10%;">備註</th>
                                <th style="width: 15%; text-align: center;">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for participant in participants_list %}
                            <tr class="vip-row" data-vip-name="{{ participant.vip.name }}"
                            data-vip-id="{{ participant.vip.id }}"
                            data-vip-nickname="{{ participant.vip.nickname }}"
                            data-vip-organization="{{ participant.vip.organization }}"
                            data-vip-position="{{ participant.vip.position }}"
                            data-vip-phone-number="{{ participant.vip.phone_number }}"
                            data-vip-email="{{ participant.vip.email }}"
                            data-invited-by="{{ participant.invited_by.username }}"
                            data-wish-ticket-count="{{ participant.wish_ticket_count }}"
                            data-notes="{{ participant.notes }}"
                            data-project-name="{{ project.name }}"
                            data-project-description="{{ project.description }}"
                            data-event-time-date="{{ participant.event_time.date }}"
                            data-event-time-session="{{ participant.event_time.session }}"
                            data-event-time-start-time="{{ participant.event_time.start_time }}"
                            data-event-time-end-time="{{ participant.event_time.end_time }}"
                            data-event-time-location-name="{{ participant.event_time.location_name }}"
                            data-event-time-location-address="{{ participant.event_time.location_address }}"
                            data-dead-line-date="{{ participant.event_time.get_dead_line_weekday }}"
                            >
                                <td style="width: 5%; text-align: center;">{{ participant.pp_id }}</td>
                                <td data-bs-toggle="modal" data-bs-target="#vipDetailModal" style="cursor: pointer; width: 6%;">
                                    <span data-bs-toggle="tooltip" data-bs-placement="right" 
                                    title="邀請時間：{{ participant.invited_at|date:"Y/m/d H:i" }}
                                    上次更新時間：{{ participant.last_update_at|date:"Y/m/d H:i" }}" style="cursor: pointer;">
                                    {{ participant.vip.name }}
                                    </span>
                                </td>
                                <td style="width: 6%;">{{ participant.vip.organization }}</td>
                                <td style="width: 6%;">{{ participant.invited_by.username }}</td>
                                <td style="width: 6%; text-align: center;">{{ participant.wish_ticket_count }}</td>
                                <td style="width: 14%; text-align: center;">{{ participant.get_status_display }}</td>
                               
                                <td style="width: 6%; text-align: center;">{{ participant.join_people_count }}</td>
                                
                                <td style="width: 5%; text-align: center;">
                                    {% if participant.send_check_email %}
                                        <i class="bi bi-check-circle text-success"></i>
                                    {% else %}
                                        <i class="bi bi-x-circle text-danger"></i>
                                    {% endif %}
                                </td>
                                <td style="width: 5%; text-align: center;">
                                    {% if participant.send_remind_email %}
                                        <i class="bi bi-check-circle text-success"></i>
                                    {% else %}
                                        <i class="bi bi-x-circle text-danger"></i>
                                    {% endif %}
                                </td>
                                <td style="width: 10%;">{{ participant.notes }}</td>
                                <td style="width: 15%; text-align: center;">
                                    <div class="btn-group btn-group-sm" role="group" aria-label="Basic example">
                                        <button type="button" class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#emailModal">
                                            <i class="bi bi-envelope"></i>
                                        </button>
                                        <button type = "button" class = "btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#updateModal{{ participant.id }}">
                                            <i class="bi bi-pencil-square"></i>
                                        </button> 
                                        <button type="button" class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#deleteModal">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <!-- 修改 Modal -->
                            <div class="modal fade" id="updateModal{{ participant.id }}" tabindex="-1" aria-labelledby="updateModalLabel{{ participant.id }}" data-bs-backdrop="static" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="updateModalLabel{{ participant.id }}">修改 {{ participant.vip.name }} 的參與資訊</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <form method="post" action="{% url 'VIPSystem_APP:update_participants_info_by_event_time' project.pk event_time.section event_time.pk %}" id="updateForm{{ participant.id }}">
                                                {% csrf_token %}
                                                <input type="hidden" name="vip_id" value="{{ participant.vip.id }}">
                                                <h6>參與場次修改</h6>
                                                <div class="row row-cols-1 row-cols-md-2 g-4">
                                                    <div class="col">
                                                        <label class="card h-100">
                                                            <div class="card-body">
                                                                <h5 class="card-title">
                                                                    <input type="checkbox" name="selected_event_time_by_section" value="all" class="form-check-input me-2 selectAll" id="selectAll{{ participant.id }}" form="updateForm{{ participant.id }}" {% if 'all' in participant.wish_attend %}checked{% endif %}>
                                                                    都可以
                                                                </h5>
                                                                <p class="card-text">
                                                                    選擇此選項表示不特別限定貴賓參與的場次，讓貴賓自由選擇
                                                                </p>
                                                            </div>
                                                        </label>
                                                    </div>
                                                    {% for event_time in event_times %}
                                                    <div class="col">
                                                        <label class="card h-100">
                                                            <div class="card-body">
                                                                <h5 class="card-title">
                                                                    <input form="updateForm{{ participant.id }}" type="checkbox" name="selected_event_time_by_section" value="{{ event_time.id }}" class="form-check-input me-2 event-time-checkbox" {% if event_time in participant.get_wish_attend_list %}checked{% endif %}>
                                                                    <!-- {{ event_time.date }} {{event_time.section}}{{ event_time.get_session_display }} -->
                                                                    {{ event_time.date }} {{event_time.section}}{{ event_time.session }}
                                                                </h5>
                                                                <p class="card-text">
                                                                    時間：{{ event_time.start_time }} - {{ event_time.end_time }}<br>
                                                                    地點：{{ event_time.location_name }}<br>
                                                                    地址：{{ event_time.location_address }}
                                                                </p>
                                                            </div>
                                                        </label>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                                <hr>
                                                <h6>希望發放票數調整</h6>
                                                <div class="row row-cols-1 row-cols-md-2 g-4">
                                                    <div class="col">
                                                        <input type="number" class="form-control" name="wish_ticket_count" value="{{ participant.wish_ticket_count }}">
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                        <div class="modal-footer justify-content-between">
                                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">取消</button>
                                            <button type="submit" form="updateForm{{ participant.id }}" class="btn btn-primary" id="confirmEventTime">送出</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <script>
                                document.getElementById('updateModal{{ participant.id }}').addEventListener('shown.bs.modal', function (event) {
                                    const modal = document.getElementById('updateModal{{ participant.id }}');
                                    const selectAllCheckbox = modal.querySelector('#selectAll{{ participant.id }}')
                                    const eventTimeCheckboxes = modal.querySelectorAll('.event-time-checkbox');

                                    function updateSelectAllState() {
                                        selectAllCheckbox.checked = Array.from(eventTimeCheckboxes).every(checkbox => checkbox.checked);
                                    }

                                    selectAllCheckbox.addEventListener('change', function() {
                                        eventTimeCheckboxes.forEach(checkbox => {
                                            checkbox.checked = this.checked;
                                        });
                                    });

                                    eventTimeCheckboxes.forEach(checkbox => {
                                        checkbox.addEventListener('change', function() {
                                            if (!this.checked) {
                                                selectAllCheckbox.checked = false;
                                            } else {
                                                updateSelectAllState();
                                            }
                                        });
                                    });
                                });
                            </script>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-center">目前尚未邀請貴賓！</p>
            {% endif %}
            {% if is_paginated %}
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page=1" data-page="{{ page_obj.previous_page_number }}" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                        {% endif %}

                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                                <li class="page-item active"><a class="page-link" href="#">{{ num }}</a></li>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
                            {% endif %}
                        {% endfor %}

                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            {% endif %}
        </div>
    </div>
    <div class="mt-3 d-flex">
        <a href="{% url 'VIPSystem_APP:project_detail' project.pk %}" class="btn btn-outline-secondary">回上層</a>
    </div>
</div>

<!-- 刪除確認 Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" data-bs-backdrop="static" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">確認刪除</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="deleteModalBody"></div>
            <div class="modal-footer" style="display: flex; justify-content: space-between;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <form action="{% url 'VIPSystem_APP:remove_participant_by_section' project.pk event_time.section %}" method="POST" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" id="participant_id" name="participant_id">
                    <button type="submit" class="btn btn-danger">確認刪除</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 寄件 Modal -->
<div class="modal fade" id="emailModal" tabindex="-1" aria-labelledby="emailModalLabel" data-bs-backdrop="static" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="emailModalLabel">寄件資訊確認</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'VIPSystem_APP:send_email_event_time' project.pk event_time.section event_time.pk %}" id="emailForm{{ participant.id }}">
                    {% csrf_token %}
                    <div class="form-group mb-3 row">
                        <input type="hidden" id="vip_id" name="vip_id">
                        <input type="hidden" id="wish_ticket_count" name="wish_ticket_count">
                        <label for="recipient_name" class="col-sm-2 col-form-label">收件人名稱</label>
                        <div class="col-sm-3">
                            <input type="text" class="form-control" id="recipient_name" name="recipient_name" required placeholder="請輸入收件人名稱">
                        </div>  
                        <label for="sender" class="col-sm-2 col-form-label">收件人 E-mail</label>
                        <div class="col-sm-5">
                            <input type="email" class="form-control" id="sender" name="sender" required placeholder="請輸入收件人電子郵件">
                        </div>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <h5>信件開頭</h5>
                        <textarea class="form-control" id="email_content" name="email_content" rows="3"></textarea>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <h5>邀請場次</h5>
                        <ul class="list-group">
                            <li class="list-group-item" id="eventInfo"></li>
                        </ul>
                    </div>
                    <input type="hidden" id="event_time_date" name="event_time_date">
                    <input type="hidden" id="event_time_session" name="event_time_session">
                    <input type="hidden" id="project_name" name="project_name">
                    <input type="hidden" id="project_description" name="project_description">
                    <input type="hidden" id="username" name="username" value="{{ username }}">
                    <div class="mb-3">
                        <h5>填表死線</h5>
                        <ul class="list-group">
                            <li class="list-group-item" id="dead_line_date_info"></li>
                            <input type="hidden" name="dead_line_date" id="dead_line_date">
                        </ul>
                    </div>
                    <div class="modal-footer justify-content-between">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">取消</button>
                        <div class="d-flex gap-3">
                            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#previewModal">信件預覽</button>
                            <button type="submit" class="btn btn-dark" id="submitBtn">送出</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 信件預覽 Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalLabel">信件預覽</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="previewContent"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="returnEmailModal" data-bs-toggle="modal" data-bs-target="#emailModal" data-bs-dismiss="modal">返回</button>
            </div>
        </div>
    </div>
</div>

<!-- 篩選姓名 Modal -->
<div class="modal fade" id="filterNameModal" data-bs-backdrop="static" tabindex="-1" aria-labelledby="filterNameModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterNameModalLabel">顯示哪些姓名</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                
                <div class="mb-3">
                    <input type="text" class="form-control" id="nameFilter" name="nameFilter" placeholder="請輸入關鍵字">
                </div>
                
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="applyFilterName()" id="applyFilterNameBtn">篩選</button>
            </div>
        </div>
    </div>
</div>

<!-- 篩選誰邀請 modal-->
<div class="modal fade" id="filterInvitedByModal" tabindex="-1" aria-labelledby="filterInvitedByModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterInvitedByModalLabel">篩選主要邀請人</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex flex-wrap">
                    {% for user in staffs %}
                        <input type="checkbox" class="btn-check" value="{{ user.id }}" id="user{{ user.id }}">
                        <label class="btn btn-outline-dark m-1" for="user{{ user.id }}"> {{ user.username }} </label>
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="applyFilterInvitedBy()" id="applyFilterInvitedByBtn">篩選</button>   
            </div>
        </div>
    </div>
</div>

<!-- 篩選單位modal-->
<div class="modal fade" id="filterOrganizationModal" data-bs-backdrop="static" tabindex="-1" aria-labelledby="filterOrganizationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterOrganizationModalLabel">篩選單位</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body"> 
                <div class="mb-3">
                    <input type="text" class="form-control" id="organizationFilter" name="organizationFilter" placeholder="請輸入單位關鍵字">
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="applyFilterOrganization()" id="applyFilterOrganizationBtn">篩選</button>
            </div>
        </div>
    </div>
</div>
<!-- 篩選狀態modal-->
<div class="modal fade" id="filterStatusModal" tabindex="-1" aria-labelledby="filterStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterStatusModalLabel">篩選回復狀態</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" id="filterStatusForm"> 
                    {% csrf_token %}
                    <div class="d-flex flex-wrap">
                        <input type="checkbox" class="btn-check" value="added" id="added">
                        <label class="btn btn-outline-dark m-1" for="added"> 尚未寄出邀請信 </label>
                        <input type="checkbox" class="btn-check" value="confirmed" id="confirmed">
                        <label class="btn btn-outline-dark m-1" for="confirmed"> 確認參加 </label>
                        <input type="checkbox" class="btn-check" value="sended" id="sended">
                        <label class="btn btn-outline-dark m-1" for="sended"> 已發送邀請信件等待回覆 </label>
                        <input type="checkbox" class="btn-check" value="declined" id="declined">
                        <label class="btn btn-outline-dark m-1" for="declined"> 拒絕參加 </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="applyFilterStatus()" id="applyFilterStatusBtn">篩選</button>   
            </div>
        </div>
    </div>
</div>

<!--顯示資訊的 modal-->
<div class="modal fade" id="vipDetailModal" tabindex="-1" aria-labelledby="vipDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="vipDetailModalLabel">貴賓詳細資訊（可由此直接修改）</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="{% url 'VIPSystem_APP:update_vip_info_by_event_time' project.pk event_time.section event_time.pk %}" method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="vipId" id="vipId">
                    <div class="row mb-3">
                      <label class="col-2 col-form-label text-center" style="justify-content: center;" >姓名<span style="color:red;">*</span></label>
                      <div class="col-3">
                        <input id="vipName" type="text" class="form-control" name="name" placeholder="請輸入貴賓姓名" required>
                      </div>
                      <label class="col-3 col-form-label text-center" style="justify-content: center;" >綽號</label>
                      <div class="col-4">
                        <input id="vipNickname" type="text" class="form-control" name="nickname" placeholder="請輸入貴賓綽號">
                      </div>
                    </div>
                    <div class="row mb-3">
                        <label class="col-2 col-form-label text-center" style="justify-content: center;" >單位<span style="color:red;">*</span></label>
                        <div class="col-3">
                          <input id="vipOrganization" type="text" class="form-control" name="organization" placeholder="請輸入貴賓單位" required>
                        </div>
                        <label class="col-3 col-form-label text-center" style="justify-content: center;" >職稱</label>
                        <div class="col-4">
                          <input id="vipPosition" type="text" class="form-control" name="position" placeholder="請輸入貴賓職稱" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <label class="col-2 col-form-label text-center" style="justify-content: center;" >電話<span style="color:red;">*</span></label>
                        <div class="col-3">
                          <input id="vipPhoneNumber" type="text" class="form-control" name="phone_number" placeholder="請輸入貴賓電話" required>
                        </div>
                        <label class="col-3 col-form-label text-center" style="justify-content: center;" >Email</label>
                        <div class="col-4">
                          <input id="vipEmail" type="text" class="form-control" name="email" placeholder="請輸入貴賓Email" required>
                        </div>
                    </div>
                    <div class="modal-footer" style="display: flex; justify-content: space-between;">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                      <button type="submit" class="btn btn-primary">送出更新</button>
                    </div>
                  </form>
            </div>
        </div>
    </div>
</div>
<script>
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })

    document.addEventListener('DOMContentLoaded', function() {
        const vipDetailModal = document.getElementById('vipDetailModal');
        // 監聽 vipDetailModal 的 show 事件
        vipDetailModal.addEventListener('show.bs.modal', handleVipDetailModal);

        // 監聽 deleteModal 的 show 事件
        const deleteModal = document.getElementById('deleteModal');
        deleteModal.addEventListener('show.bs.modal', handleDeleteModal);

        // 監聽 emailModal 的 show 事件
        const emailModal = document.getElementById('emailModal');
        emailModal.addEventListener('show.bs.modal', handleEmailModal);

        // 監聽 previewModal 的 show 事件
        const previewModal = document.getElementById('previewModal');
        previewModal.addEventListener('show.bs.modal', handlePreviewModal);
    });

    function handlePreviewModal(event) {
        var formData = document.getElementById('emailForm');
        var emailForm = new FormData(formData);
        console.log(emailForm);
        if (emailForm) {
            var emailContent = emailForm.get('email_content');
            var recipientName = emailForm.get('recipient_name');
            var senderEmail = emailForm.get('sender');
            var eventTimeDate = emailForm.get('event_time_date'); // 獲取 event_time 
            var eventTimeSession = emailForm.get('event_time_session'); // 獲取 event_time 
            var projectName = emailForm.get('project_name');
            var projectDescription = emailForm.get('project_description');
            var wish_ticket_count = emailForm.get('wish_ticket_count');
            var dead_line_date = emailForm.get('dead_line_date');    
            var previewContent = `
                <h4>親愛的${recipientName} 您好：</h4>

                <p>
                    ${emailContent}
                </p>
                <p>
                    感謝您一路以來對薩泰爾娛樂的支持，<br>
                    我們將於 <strong style="color:darkred;">${eventTimeDate}</strong> 舉辦<strong >【${projectName} ${eventTimeSession}】的錄影活動</strong> <br>
                </p>
                <p>
                    請於下方連結中填寫資料，敬請於 <strong style="color:darkred;">${dead_line_date}</strong> 前填寫完成，期待您的蒞臨！
                </p>
                </p>

                <p>
                    <a href="#">☞點擊按鈕確認參加！</a>
                </p>

                <p>
                    活動日期：<strong>${eventTimeDate}</strong><br>
                    場館地址：<strong>壹電視攝影棚 (台北市內湖區新湖二路146巷18號)</strong><br>
                    進場時間：<strong>17:00 - 18:00</strong><br>
                    演出時間：<strong>18:00 - 21:00</strong>
                </p>

                <p>
                    填寫時麻煩留意以下資訊：
                    <ul>
                        <li>出席人數以 <strong style="color:darkred;">${wish_ticket_count}</strong> 人為限</li>
                        <li>報名成功後，薩泰爾娛樂最晚將於一週內寄出電子「出席確認信」，若逾期仍未收到「出席確認信」，請儘速與邀請您的夥伴或禮賓統籌聯繫。</li>
                    </ul>
                </p>
                <p>
                    <strong>【${projectName}】禮賓統籌</strong><br>
                    游幃傑 Jerry Yu<br>
                    jerryyu@strnetwork.cc<br>
                    0924-109-008
                </p>
                <p>保留席有限，敬請把握登記！</p>
                <p>薩泰爾娛樂 敬上</p>
                <h3>▶現場注意事項</h3>
                <ol>
                    <li>本節目錄影全長約 110 至 140 分鐘（含中場休息）。遲到觀眾須於主辦單位安排之時間點，在工作人員的引導之下入場，不得異議。</li>
                    <li>未經主辦單位同意，場內禁止錄影、錄音、拍照、限時動態。</li>
                    <li>主辦單位未公開節目內容前，需對內容完全保密。</li>
                    <li>本節目禁止攜帶外食、飲料、任何種類之金屬、玻璃、雷射筆、煙火或任何危險物品。</li>
                    <li>本節目無尺度限制，18 歲以下觀眾建議由成年人陪同觀賞。</li>
                    <li>全場次皆為錄影場，入場即代表您同意個人肖像權可作為薩泰爾娛樂股份有限公司 -【 賀瓏夜夜秀 】使用。</li>
                    <li>全場次皆為現場錄影，攝影機架設、移動尊重現場導播指示，如有部分阻擋視線敬請見諒。</li>
                </ol>
            `;
            var previewContentDiv = document.getElementById('previewContent');
            previewContentDiv.innerHTML = previewContent;
        };
    }


    function handleEmailModal(event) {
        const trigger = event.relatedTarget;
        const parentRow = trigger.closest('.vip-row');
        if (parentRow) {
            document.getElementById('recipient_name').value = parentRow.dataset.vipName;
            document.getElementById('vip_id').value = parentRow.dataset.vipId;
            document.getElementById('wish_ticket_count').value = parentRow.dataset.wishTicketCount;
            document.getElementById('event_time_date').value = parentRow.dataset.eventTimeDate;
            document.getElementById('event_time_session').value = parentRow.dataset.eventTimeSession;
            document.getElementById('project_name').value = parentRow.dataset.projectName;
            document.getElementById('project_description').value = parentRow.dataset.projectDescription;
            document.getElementById('sender').value = parentRow.dataset.vipEmail;
            document.getElementById('email_content').value = `嗨 ${parentRow.dataset.vipName} 好久不見！`;
            document.getElementById('eventInfo').innerHTML = `
                <strong>${parentRow.dataset.eventTimeDate} ${parentRow.dataset.eventTimeSession}</strong>
                <br>
                <small>
                    時間：${parentRow.dataset.eventTimeStartTime} - ${parentRow.dataset.eventTimeEndTime} | 
                    地點：${parentRow.dataset.eventTimeLocationName} | 
                    地址：${parentRow.dataset.eventTimeLocationAddress}
                </small>
            `;
            document.getElementById('dead_line_date_info').innerHTML = `
                <strong>${parentRow.dataset.deadLineDate}</strong>
            `;
            document.getElementById('dead_line_date').value = parentRow.dataset.deadLineDate;
        };

        // 設置表單提交事件
        const emailForm = document.getElementById('emailForm');
        emailForm.addEventListener('submit', function(e) {
            var submitBtn = e.target.querySelector('#submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = ' <span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span> 寄件中請稍候';
        });
    }

    function handleDeleteModal(event) {
        const trigger = event.relatedTarget;
        const parentRow = trigger.closest('.vip-row');
        if (parentRow) {
            document.getElementById('deleteModalBody').innerHTML = `您確定要刪除 <strong>${parentRow.dataset.vipName}</strong> 嗎？`;
            document.getElementById('participant_id').value = parentRow.dataset.vipId;
        }
    }

    function handleVipDetailModal(event) {
        const trigger = event.relatedTarget;
        const parentRow = trigger.closest('.vip-row');
        
        if (parentRow) {
            const vipDetailModal = document.getElementById('vipDetailModal');
            vipDetailModal.querySelector('#vipId').value = parentRow.dataset.vipId;
            vipDetailModal.querySelector('#vipName').value = parentRow.dataset.vipName;
            vipDetailModal.querySelector('#vipNickname').value = parentRow.dataset.vipNickname;
            vipDetailModal.querySelector('#vipOrganization').value = parentRow.dataset.vipOrganization;
            vipDetailModal.querySelector('#vipPosition').value = parentRow.dataset.vipPosition;
            vipDetailModal.querySelector('#vipPhoneNumber').value = parentRow.dataset.vipPhoneNumber;
            vipDetailModal.querySelector('#vipEmail').value = parentRow.dataset.vipEmail;
        };
    }

    function applyFilterName() {
        var nameFilter = document.getElementById('nameFilter').value;
        var url = new URL(window.location.href);
        if (nameFilter == '') {
            url.searchParams.delete('nameFilter');
        } else {
            url.searchParams.set('nameFilter', nameFilter);
        }
        // 重置頁碼到第一頁
        url.searchParams.set('page', 1);
        window.location.href = url.toString();
    }

    function applyFilterInvitedBy() {
        var selectedInvitedBy = [];
        var checkboxes = document.querySelectorAll('#filterInvitedByForm input[type="checkbox"]:checked');
        checkboxes.forEach(function(checkbox) {
            selectedInvitedBy.push(checkbox.value);
        });
        var url = new URL(window.location.href);
        url.searchParams.delete('filter_invited_by');
        selectedInvitedBy.forEach(function(staff_id) {
            url.searchParams.append('filter_invited_by', staff_id);
        });
        // 重置頁碼到第一頁
        url.searchParams.set('page', 1);
        window.location.href = url.toString();
    }

    function applyFilterStatus() {
        var selectedStatus = [];
        var checkboxes = document.querySelectorAll('#filterStatusForm input[type="checkbox"]:checked');
        checkboxes.forEach(function(checkbox) {
            selectedStatus.push(checkbox.value);
        });
        var url = new URL(window.location.href);
        url.searchParams.delete('filter_status');
        selectedStatus.forEach(function(status) {
            url.searchParams.append('filter_status', status);
        });
        // 重置頁碼到第一頁
        url.searchParams.set('page', 1);
        window.location.href = url.toString();
    }

    function applyFilterOrganization() {
        var organizationFilter = document.getElementById('organizationFilter').value;
        var url = new URL(window.location.href);
        if (organizationFilter == '') {
            url.searchParams.delete('organizationFilter');
        } else {
            url.searchParams.set('organizationFilter', organizationFilter);
        }
        window.location.href = url.toString();
    }
</script>
{% endblock %}
